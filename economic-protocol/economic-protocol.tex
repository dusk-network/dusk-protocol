%\documentclass[twocolumn, nofootinbib]{revtex4-2} %uncomment to hide comments
\documentclass[draft, twocolumn, nofootinbib]{revtex4-2} %uncomment to see comments

% General comments:
% contract vs. function in a contract
% crossover
% direct

\usepackage{multirow}
\usepackage{array}
\usepackage[colorinlistoftodos, textwidth = 20mm, obeyDraft]{todonotes}
\newcommand{\mbi}[1]{{\todo[inline, size=\small, color=olive!40]{\textbf{Marta}: #1}}}

\usepackage{xspace}
\newcommand{\dusk}{{\footnotesize\textsf{DUSK}}\xspace}

\usepackage{setspace}

% Emphasized words
\newcommand{\emphathize}[1]{\textbf{#1}\xspace}
\newcommand{\blockgenerator}{\emphathize{block generator}}
\newcommand{\contract}{\emphathize{contract}}
\newcommand{\contractaccount}{\emphathize{contract account}}
\newcommand{\ctoc}{\emphathize{C2C}}
\newcommand{\direct}{\emphathize{direct}}
\newcommand{\fee}{\emphathize{fee}}
\newcommand{\gas}{\emphathize{gas}}
\newcommand{\gasprice}{\emphathize{gas price}}
\newcommand{\gaslimit}{\emphathize{gas limit}}
\newcommand{\gasconsumed}{\emphathize{gas consumed}}
\newcommand{\gasunspent}{\emphathize{gas unspent}}
\newcommand{\insufficientgas}{\emphathize{insufficient gas}}
\newcommand{\Insufficientgas}{\emphathize{Insufficient gas}}
\newcommand{\icc}{\emphathize{ICC}}
\newcommand{\provider}{\emphathize{provider}}
\newcommand{\transfercontract}{\emphathize{transfer contract}}
\newcommand{\user}{\emphathize{user}}
\newcommand{\users}{\emphathize{users}}

\begin{document}
    \title{Dusk Economic Model}
    \author{Emanuele Francioni}
    \email{emanuele@dusk.network}
    \author{Matteo Ferretti}
    \email{matteo@dusk.network}
    \affiliation{Dusk Network}
%    \date{\today}

%    \begin{abstract}
%    	Abstract.
%    \end{abstract}

    \maketitle
    
%    \tableofcontents

	\section{Introduction}\label{sec:introduction}
	\mbi{I moved the abstract to this initial section.}
	The economic model of Dusk encompasses the mechanisms enabling smart
	contract owners to create economic value through the services they offer.
	It consists of levying service fees, offsetting gas costs for users,
	and optimizing gas payments for improved profitability.
	Essentially, the economic model allows service providers to be
	productized and for profit.

    \section{Terminology}\label{sec:terminology}
    Throughout this document, we use the following terms.
    \mbi{I added two terms that were used across the doc: \transfercontract,
    \blockgenerator.}    
    \begin{itemize}
        \item \contract: smart contract method activated by the user
              through a transaction.
        \mbi{With this definition, any function of an smart contract is
        called a \contract. However, in this document, the word \contract
        seems to have two different meanings: (1) a method of an smart contract
        and (2) a smart contract. I think it is best to call the functions
        of a smart contract just functions or \textbf{methods}.}
        \mbi{Following my above comment, when talking about \icc, by this
        definition, an smart contract with two different methods where one
        calls the other, would also be considered an \icc, although there is
        only one smart contract involved. Terminology seems counterintuitive to me.}
        \item \user: party initiating the \contract transaction.
        \item \gas: unit measure of computational resource.
              In this scope, \gaslimit indicates the maximum amount of
              resources allocated by a user or a contract to perform a
              computation, \gasconsumed measures incurred costs of
              computation executed, \gasunspent is the difference
              between \gaslimit and \gasconsumed.
              If a computation requires more resources than those allocated,
              then we incur in an \insufficientgas error.
        \item \gasprice: amount of \dusk that a sender is
              willing to spend per unit of gas (the amount is specified in
              Lux, where 1 Lux equals 10\textsuperscript{-9} \dusk). The higher
              the \gasprice, the more incentivized are the block generators
              to include the transaction in the next block. This way, transactions
              with high gas prices are generally confirmed more quickly.
              Because of this, \gasprice generally determines the
              transaction priority.
        \item \icc (inter-contract call): interaction between
              multiple contracts. ICCs cannot be called directly. As such, the
              contract methods should be tagged as \ctoc (contract-to-contract) or
              \direct. The former can only be called only by another contract,
              while the latter can only be called by a user through a
              transaction.
              %This term is also used interchangeably for those contract methods that
              %can only be called by other contract.
        \item \fee: amount of \dusk charged by a smart contract to a user, when the
              former requires payment for its services.
              The \fee is known by the transfer contract (changeable
              through a transaction), but needs to be communicated to the user,
              who approves/signes it.
              This way the possibility of fee malleability is removed, thus
              preventing a bait-and-switch attack where a contract could change
              the fee with a high priority transaction and drain the user's
              funds.
              \mbi{It is not clear to me how this attack is prevented. Is it that when
              the user calls the contract with a transaction, he includes as part of
              the transaction a signature with the fixed fee so that if the fee changes,
              then the transaction is reverted?}
        \item \contractaccount: in the scenario where the contract pays
              for gas on behalf of the user, this account is
              where fees are accrued and gas is paid.
        \item \provider: intermediary service entity between a
              \user and a \contract.
    	\item \transfercontract: smart contract responsible for handling \dusk.
    	\item \blockgenerator: full-node eligible to propose a candidate block to the network. 
    \end{itemize}

    \section{Specification}\label{sec:specifications}
	In this section, we describe how gas is handled in different scenarios. We summarize all cases in Table~\ref{tab:gas}.
    \begin{table*}[t]
    \begin{tabular}{|m{0.15\linewidth}|m{0.1\linewidth}|b{0.45\linewidth}|b{0.3\linewidth}|}
        \hline
        \textbf{Scenario} & \textbf{Contract fee} &
        \textbf{Normal flow} & \Insufficientgas \\
        \hline
        \hline
        1. User pays gas & No &
        \begin{itemize}
            \item 70\% \gasunspent returned to \user.
            \item 30\% \gasunspent paid to executed contracts depending
                  on the \gaslimit allocated across \icc.
            \item 100\% \gasconsumed paid to the \blockgenerator.
        \end{itemize} &
        \begin{itemize}
            \item 100\% \gasconsumed paid to the \blockgenerator.
        \end{itemize} \\
        \hline
        2. User pays gas; contract applies fee & Yes &
        \begin{itemize}
            \item Like Scenario 1.
            \item \fee paid to the charging contract.
        \end{itemize} &
        \begin{itemize}
            \item 100\% \gasconsumed paid to the \blockgenerator.
            \item \fee returned to \user.
        \end{itemize} \\
        \hline
        3. Contract pays gas; contract applies fee & Yes &
        \begin{itemize}
            \item \gasconsumed charged entirely to \contract.
            \item 30\% \gasunspent paid to executed contracts depending
                  on the \gaslimit allocated across \icc.
            \item 70\% \gasunspent returned to contract.
            \item 100\% \gasconsumed paid to the \blockgenerator.
            \item \fee paid to the charging contract.
        \end{itemize} &
        \begin{itemize}
            \item 100\% \gasconsumed locked for a number of epochs.
            \item \fee gets refunded to the \user.
        \end{itemize} \\
        \hline
        4. Obfuscated transactions & Variable, \% of an obfuscated amount & As in
        Scenario 3, \fee is calculated as \% of transacted amount. &
        Additional considerations needed. \\
        \hline
        5. Autocontracts & No & TBD & TBD \\
        \hline
    \end{tabular}
        \caption{Summary of how gas and fees are handled in each scenario.}
    	\label{tab:gas}
    \end{table*}

    \subsection{Scenario 1: User pays gas}\label{sec:specifications:scenario-1}
    This case mirrors the conventional gas expenditure method in most
    blockchains.
    The \user specifies a \gaslimit and a \gasprice.

    \subsubsection{Normal flow}\label{sec:specifications:scenario-1:normal-flow}
    
    In this case, all \gasconsumed is transferred to the \blockgenerator. From the remaining \gasunspent, 70\% reverts to the \user. Then, the \direct contract keeps 30\% of \gasunspent and each \icc receives 30\% of its own \gasunspent.

	\mbi{I have a remark for this scenario.} 
    The most notable contract that uses this kind of strategy is perhaps the
    \transfercontract, which (according to the current configuration)
    will accrue  30\% of the gas spent per transaction.
    Because of this, Dusk will no longer be the recipient of 10\% of the gas
    consumed overall.

    \subsubsection{Insufficient gas}\label{sec:specifications:scenario-1:insufficient-gas}
	In this case, 100\% of \gasconsumed (all gas) is transferred to the \blockgenerator.

    \subsubsection{Reward to contracts}\label{sec:specifications:scenario-1:insufficient-gas-1:reward-to-contract}
    In this scenario, the reward to the contract is paid by the user,
    considering that the whole gas spent goes to the network, and the
    percentile paid to the direct contract and the ICC is taken from the
    crossover.
    It might make sense to let the contracts establish what they want to be
    paid (with a maximum amount) and communicate this information during the
    calculation of the reward.
    \mbi{\textit{Rewards} are not defined anywhere. Is this an extra amount of \dusk paid by 
   		the user?}     
	\mbi{\textit{Crossover} is a technical detail that it is also not defined and maybe adds too much
		noise to this section.}
	
    \subsection{Scenario 2: User pays gas, contract applies fee}\label{subsec:scenario-2}
    This scenario mirrors the previous one, but with an additional \fee
    that the \user must add to the transaction.
    The \user sets \gaslimit, \gasprice, and \fee.

    \subsubsection{Normal flow}\label{sec:specifications:scenario-2:normal-flow}
	As in Section~\ref{sec:specifications:scenario-1:normal-flow}, all \gasconsumed is transferred to the \blockgenerator. From the remaining \gasunspent, 70\% reverts to the \user. Then, the \direct contract keeps 30\% of \gasunspent and each \icc receives 30\% of its own \gasunspent.
	\mbi{I have the same observation as before.}
    
    \subsubsection{Insufficient gas}\label{sec:specifications:scenario-2:insufficient-gas}
    In this case, 100\% of \gasconsumed (all gas) is transferred to the \blockgenerator and the \fee is refunded to the \user.

    \subsection{Scenario 3: Contract pays gas, contract applies fee}\label{sec:specifications:scenario-3}
    This represents a unique approach in the blockchain domain.
    This model lets a contract set a fixed \fee paid by the user.
    The special case when a \fee does not cover the contract's gas costs
    is described in Section~\ref{sec:specifications:scenario-3:user-pays-fees-lesser}.

    \subsubsection{Normal flow}\label{sec:specifications:scenario-3:normal-flow}
    \begin{itemize}
        \item The \direct contract pays for \gas by setting
              \gaslimit and \gasprice.
        \item The \direct contract earns the \fee paid by the \user.
        \item Each \icc is paid 30\% of its own \gasunspent.
        \item 100\% of \gasconsumed is transferred to the \blockgenerator.
    \end{itemize}

    \subsubsection{Insufficient gas}\label{sec:specifications:scenario-3:insufficient-gas}
    A smart contract incurring in an \insufficientgas error is exposed
    to threats, detrimental to the network.
    Hence, in this case, instead of subtracting the \gas from the
    contract's reserve and allocating it to \icc or
    \blockgenerator, the \gas is locked and returned after a
    set number of epochs (e.g.\ 5 epochs).
    This deters malevolent overloading by \icc or
    \blockgenerator, safeguarding the contract's \dusk.\
    Specifically, locked gas isn't disbursed but held for a duration of epochs.
    Additionally, the \fee is refunded to the \user.

    \begin{itemize}
        \item \gasconsumed is not paid to anyone, but gets locked for
              a number of epochs,
        \item \fee is refunded to the \user.
    \end{itemize}

    \subsubsection{Setting gas price and limit}\label{sec:specifications:scenario-3:setting-gas-price-and-limit}
    The contract determines user priority by indicating a \gasprice
    (together with \gaslimit and the \fee) to Rusk and likely
    utilize host data (e.g.\ overall gas spent in the last block, epoch median,
    congestion metrics, etc.\ ) to present users with a spectrum of service
    levels, each attached to a specific \fee.

    Contracts should set the \gaslimit and  according
    to any kind of logic they deem the most appropriate, as long as this is done
    autonomously.
    From their side, users should merely interact with contracts and incur a
    clear and simple upfront \fee, oblivious of gas complexities.

    \subsubsection{User pays fees lesser than gas paid by contract}\label{sec:specifications:scenario-3:user-pays-fees-lesser}
    Certain situations might lead a contract to subsidize some or all
    transaction costs.
    In these cases, the contract must deliberately allow this by deactivating
    \textbf{insufficient fee safety check} (akin to an \textbf{unsafe} block in
    rust).
    If the check is activated, scenarios where the user's \fee falls below the
    gas expended by the contract should activate the same behaviour described
    in insufficient gas scenario in Section~\ref{sec:specifications:scenario-3:insufficient-gas}: the
    \fee is returned to the user, and an equivalent amount gets locked
    on the \contractaccount.

    \subsubsection{Service provider contract}\label{sec:specifications:scenario-3:service-provider-contract}
    The entities in the use case are: \user, \textbf{target contract},
    \textbf{(service) provider}.
    The \provider generally offers a helper service to \users,
    most frequently a proof generation service.
    For the service offered, \provider shall be paid.
    In this case the \user invokes a \provider's contract which
    wraps the call to the \textbf{target contract}.
    Since the \provider creates the proof, it can then be sure of
    payment.
    Since the \user creates the unmalleable unproven transaction,
    \provider cannot invoke any different \contract.

    The \provider is a contract template designed for those who want to
    advertise and broker infrastructural services.
    Its primary purpose is to create a marketplace for Provers and potentially
    provide other services too such as subscription, off-chain payments, etc.
    Implementing the prover fee through a smart contract offers several
    advantages over using multiple output circuits:

    \begin{enumerate}
        \item \textbf{Reduced note proliferation}: Fees managed by a contract
              can be accumulated within a single note, which can be withdrawn
              later
        \item \textbf{Instant notification of new services}: Wallets are
              immediately notified of new services and their fees through a
              simple event broadcast by registrars
        \item \textbf{Support for off-chain services}: The contract allows
              notifications and incentives for off-chain services, such as
              community-run proof sequencers and provers
    \end{enumerate}

    Incorporating the Service Provider Smart Contract into the Economic
    Protocol's considerations and modeling is essential.
    It promotes incentives for provers and enables wallets to be notified of
    different provers' services.

    \subsection{Scenario 4: Contract charges a percentage of an obfuscated amount}\label{sec:specifications:scenario-4}
    This is another novel scenario, suitable for cases where the contract may
    benefit from the volume of transacted assets, such as DEXs, Zedger tokens,
    bulletin-board, etc.
    The contract may wish to waive gas costs for users as the fee might
    adequately cover these costs.
    This scenario requires the user to produce a proof based on the percentage
    of the transacted amount.
    However, further consideration is needed to determine if this payment can
    be generalized within the Transfer Contract, or if this mechanism must be
    completely delegated to the smart contract method.

    \subsection{Scenario 5: Autocontracts}\label{sec:specifications:scenario-5}

    With autocontracts, we mean event listening contracts.
    These are smart contracts that get executed automatically as soon as an
    event they subscribe to gets emitted.
    This is possible since contracts can pay for their own gas.
    In this case an autocontract would be close to contracts paying their own
    gas and applying 0 fee.

    The business case for such autocontracts is quite interesting and
    compelling.
    For example, we could implement limit orders or some actions related to
    asset price movements.

    In order to be useful, autocontracts should be able to do everything
    ``normal'' contracts do, including having a state and calling other
    contracts in the ``normal contract'' space.

    \subsubsection{Pending questions}\label{sec:specifications:scenario-5:pending-questions}
    \textbf{Which subscriber contract executes first? Is it a simple "contract
            ID order", or a more complicated "contract fee order"?}

    This is an interesting question and way more profound than you probably
    perceive right now.
    For the simple reason that in all ``normal'' transactions, the block
    generator is not bound to order by fees (although we expect him to).
    However, the block generator has (should have) no power to stop an
    autocontract and therefore any heuristics we follow is protocollar by
    definition and way stricter.

    \textbf{How are subscribers executed? Immediately after the event is
    triggered, or after regular execution is done? Maybe even after a batch of
    executions is done?}

    This is another much deeper question that has far reaching implications
    gas-wise.
    For instance, if we would allow subscriber execution immediately after an
    event, this would mean that their gas would add to the block gas limit and
    might prevent some other transactions to be executed (this might also be an
    attack BTW). If we do stuff at the end of a batch, though, this would
    complicate things quite substantially since a limit order might be
    ``gamed'' by some other executed transaction.
    In other words, after-batch autocontract execution would be very vulnerable
    to sandwich bots.

    \section{Model discussion}\label{sec:discussion}
    Dusk differs from traditional blockchain models by charging gas fees to
    contracts rather than users.

    \begin{itemize}
        \item This approach fundamentally improves user experience
        \item Solidifies long-term developer commitment through a sustainable
              revenue stream
        \item It departs from conventional models where network congestion sets
              the price, opting instead for a cost-effective utilization-based
              approach
        \item Shifts the focus from speculative tokens to genuine service
              utility, minimizing scams, and conferring special advantages to
              financial institutions by aligning with regulatory compliance
              requirements
    \end{itemize}

    \subsection{But we can already do this without changing much!}\label{sec:discussion:but-we-can-already-do-this}
    Adopting the economic protocol at Dusk's base layer rather than at the
    application level yields unique strategic benefits.
    It promotes a unified approach to the UX of wallets and clients, and
    incentivizes novel feature creation through a standardized base layer.
    In fact, the very concept of autocontracts from Section~\ref{sec:specifications:scenario-5} emerges
    from this setup and would not be possible at application level, offering a
    truly unique mechanism to create a scalable market for optimized smart
    contracts.
    We could reason in terms of network-wide optimizations and security rather
    than leaving these to the developers.

    Developer focus shifts from payment system intricacies to advanced network
    architecture and unique application features due to the ease of development.
    The consistency in security practices, coupled with operational efficiency,
    positions the Dusk for sustainable scalability and a robust future-proof
    framework.

    \subsection{Addressing perverse incentives}\label{sec:discussion:addressing-perverse-incentives}
    A crucial aspect of the economic model is to motivate developers and
    maintain the sustainability of smart contracts.
    However, offering rewards by rebating (part of) gas to the owner, as
    observed in some other blockchain platforms, might result in perverse
    incentives, such as developing inefficient contracts deliberately or
    targeting high-value users.
    Instead, Dusk strives to provide a superior mechanism that aligns with
    real-world practices and guarantees the economic sustainability of smart
    contracts without introducing unnecessary complications.

    \section{Innovative cost management approach}\label{sec:innovative-cost-management-approach}
    Dusk's Economic Model stands out from traditional approaches by allowing
    users to pay smart contracts directly and specify their preferred payment
    method to the Transfer Contract.
    This model permits the transfer of gas costs to contracts rather than users,
    aligning more closely with conventional scenarios where service providers
    bear infrastructural costs.

    Albeit other blockchains are trying to create incentives for smart contract
    developers (owners), they all tend to keep the current gas philosophy quite
    unchanged, that is users pay for gas, i.e.\ part of gas spent by the user is
    thus paid to contracts' owner.

	\scalebox{0.87}{
    \begin{tabular}{|m{0.3\linewidth}|m{0.7\linewidth}|}
        \hline
        Configuration & Contract Owner Incentives \\
        \hline
        \hline
        Traditional & No incentive (Owner's margin is \textbf{absent}, or
        depends on the smart-contract's specific logic) \\
        \hline
        Gas-subsidized contracts & Owner is subsidized by users' gas: a
        percentile of the gas fees no longer goes to the Block Generator, but
        to the invoked contracts \\
        \hline
        Gas-and-mint subsidized contracts & Owner is subsidized by users' gas
        and also part of the block reward \\
        \hline
    \end{tabular}}

    \subsection{User pays gas}\label{sec:innovative-cost-management-approach:user-pays-gas}
    This is how gas has been traditionally handled so far.
    Users pay gas fees which are dependent on platform's activity and smart
    contracts' complexity.
    There is no default incentive to smart contracts developers.
    This is among the reasons for the proliferation of questionable utility
    tokens, used by developers and VCs as incentives.

    \subsection{Gas subsidized contracts}\label{sec:innovative-cost-management-approach:gas-subsidized-contracts}
    According to this model, part of the gas spent by users is paid to contract
    owners/developers.
    Fantom\footnote{https://docs.fantom.foundation/funding/gas-monetization},
    NEAR\footnote{https://wiki.dusk.network/org/roadmap/economic-model\#platform-pays-contracts},
    and Archway\footnote{https://docs.archway.io/overview/rewards} propose slight
    variations with this kind of approach.
    We find such an approach undesirable and leading to the creation of perverse
    incentives.
    Moreover, gas should be added to the Block Generator's reward to
    incentivize her to produce non-empty blocks.
    When protocol's inflation is over, gas fees are the only method to
    incentivize block producers, and therefore it is unwise to remove them.

    \subsection{Gas and mint subsidized contracts}\label{sec:innovative-cost-management-approach:gas-and-mint-subsidized-contracts}
    Like above, but with the addition of a percentile of the inflation going to
    owners.
    
    \begin{thebibliography}{99}
    	\bibitem{item} Author et al., {\it Title of the paper}. 3d ed. Editorial, Place: year. Link: (date of consultation). 
   	\end{thebibliography}

\end{document}
